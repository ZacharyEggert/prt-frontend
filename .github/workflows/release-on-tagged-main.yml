name: Release on Tagged Main Commit

on:
  push:
    branches:
      - main
    tags:
      - 'v*.*.*'
      - '*.*.*'

permissions:
  contents: write

jobs:
  find-release-tag:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.tag.outputs.should_release }}
      release_tag: ${{ steps.tag.outputs.release_tag }}
      target_sha: ${{ steps.tag.outputs.target_sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Resolve release tag and commit
        id: tag
        shell: bash
        run: |
          release_tag=''
          target_sha=''
          semver_pattern='^v?[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?(\+[0-9A-Za-z.-]+)?$'

          if [[ "${GITHUB_REF_TYPE}" == 'tag' ]]; then
            candidate_tag="${GITHUB_REF_NAME}"
            if [[ "$candidate_tag" =~ $semver_pattern ]]; then
              tagged_sha="$(git rev-list -n 1 "$candidate_tag")"
              git fetch origin main --depth=1
              if git merge-base --is-ancestor "$tagged_sha" origin/main; then
                release_tag="$candidate_tag"
                target_sha="$tagged_sha"
              fi
            fi
          else
            while IFS= read -r tag; do
              if [[ "$tag" =~ $semver_pattern ]]; then
                release_tag="$tag"
                target_sha="$GITHUB_SHA"
              fi
            done < <(git tag --points-at "$GITHUB_SHA")
          fi

          if [[ -n "$release_tag" ]]; then
            echo "should_release=true" >> "$GITHUB_OUTPUT"
            echo "release_tag=$release_tag" >> "$GITHUB_OUTPUT"
            echo "target_sha=$target_sha" >> "$GITHUB_OUTPUT"
            echo "Release tag detected: $release_tag at $target_sha"
          else
            echo "should_release=false" >> "$GITHUB_OUTPUT"
            echo 'No SemVer release tag found on the pushed commit.'
          fi

  build:
    needs: find-release-tag
    if: needs.find-release-tag.outputs.should_release == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            build_command: bun run build && bunx electron-builder --linux AppImage --publish never
            artifact_glob: dist/prt-frontend-*.AppImage
          - os: macos-latest
            build_command: bun run build && bunx electron-builder --mac zip --publish never
            artifact_glob: dist/prt-frontend-*-mac.zip
          - os: windows-latest
            build_command: bun run build && bunx electron-builder --win nsis --publish never
            artifact_glob: dist/prt-frontend-*-setup.exe
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.find-release-tag.outputs.target_sha }}

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run build command
        run: ${{ matrix.build_command }}

      - name: Upload release artifact
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.os }}
          path: ${{ matrix.artifact_glob }}
          if-no-files-found: error

  release:
    needs:
      - find-release-tag
      - build
    if: needs.find-release-tag.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Download built artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: release-*
          merge-multiple: true
          path: release-assets

      - name: Create GitHub release from source
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.find-release-tag.outputs.release_tag }}
          target_commitish: ${{ needs.find-release-tag.outputs.target_sha }}
          generate_release_notes: true
          prerelease: ${{ contains(needs.find-release-tag.outputs.release_tag, '-') }}
          files: |
            release-assets/prt-frontend-*-setup.exe
            release-assets/prt-frontend-*-mac.zip
            release-assets/prt-frontend-*.AppImage
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
