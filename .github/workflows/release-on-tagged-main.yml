name: Release on Tagged Main Commit

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  find-release-tag:
    runs-on: ubuntu-latest
    outputs:
      should_release: ${{ steps.tag.outputs.should_release }}
      release_tag: ${{ steps.tag.outputs.release_tag }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find release tag on pushed commit
        id: tag
        shell: bash
        run: |
          release_tag=''
          semver_pattern='^v?[0-9]+\.[0-9]+\.[0-9]+(-[0-9A-Za-z.-]+)?(\+[0-9A-Za-z.-]+)?$'

          while IFS= read -r tag; do
            if [[ "$tag" =~ $semver_pattern ]]; then
              release_tag="$tag"
            fi
          done < <(git tag --points-at "$GITHUB_SHA")

          if [[ -n "$release_tag" ]]; then
            echo "should_release=true" >> "$GITHUB_OUTPUT"
            echo "release_tag=$release_tag" >> "$GITHUB_OUTPUT"
            echo "Release tag detected: $release_tag"
          else
            echo "should_release=false" >> "$GITHUB_OUTPUT"
            echo 'No SemVer release tag found on the pushed commit.'
          fi

  build:
    needs: find-release-tag
    if: needs.find-release-tag.outputs.should_release == 'true'
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            script: build:linux
          - os: macos-latest
            script: build:mac
          - os: windows-latest
            script: build:win
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run build script
        run: bun run ${{ matrix.script }}

  release:
    needs:
      - find-release-tag
      - build
    if: needs.find-release-tag.outputs.should_release == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Create GitHub release from source
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.find-release-tag.outputs.release_tag }}
          target_commitish: ${{ github.sha }}
          generate_release_notes: true
          prerelease: ${{ contains(needs.find-release-tag.outputs.release_tag, '-') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
